#!/usr/bin/env ruby
# TODO: This should be ported to JS, but it only took me a few minutes
# in ruby and has no dependencies outside the stdlib.
require 'rexml/document'
include REXML

def titleize(name)
    name[0] = name[0].upcase
    name.gsub(/-(.)/) {|match| match[1].upcase}
end

def icon_js(name, view_box, nodes)
    nodes = nodes.map {|node| "#{node}"}
    return <<-JS
/* @flow */
/* jscs: disable */
/* This code is generated by ./script/iconify - do not edit. */

import React from "react";
import mui from "material-ui";

export default class SvgIcon#{name} extends React.Component {

    render(): React.Element {
        return (
            <mui.SvgIcon
                {...this.props}
                className={ `${this.props.className || ''} #{name}Icon` }
                viewBox="#{view_box}"
            >
            #{nodes.join("\n            ")}
            </mui.SvgIcon>
        );
    }

}
JS
end

def view_box(doc)
    XPath.first(doc, '//svg').attributes.get_attribute('viewBox').value
end

def nodes(doc)
    n = XPath.each(doc, '//path|//circle').to_a
    n.map do |node|
        # remove style elements as we don't want them
        node.attributes.delete('style')
        # remove tabs and newlines
        node.attributes.each{|name, value|
            value = value.gsub(/[\t\n]/, ' ')
            node.add_attribute(name, value)
        }
    end

    return n
end

def class_name(source_path)
    titleize(File.basename(source_path).
        gsub("askizzy-icon-", '').
        gsub(/.svg$/, '')
    )
end

source_dir = ARGV[0] || "../designs/icons/"
dest_dir = ARGV[1] || "./src/icons/"

source_icons = Dir.glob(source_dir + '/askizzy-icon-*.svg').sort
source_icons.each do |source_path|
    class_name = class_name(source_path)
    doc = Document.new(File.read(source_path))
    viewBox = view_box(doc)
    nodes = nodes(doc)
    File.open("#{dest_dir}/#{class_name}.js", 'w') do |out|
        out.write icon_js(class_name, viewBox, nodes)
    end
end

File.open('src/icons/index.js', 'w') do |f|
    source_icons.each do |source_path|
        class_name = class_name(source_path)
        f.write "import SvgIcon#{class_name} from './#{class_name}.js';\n"
    end
    f.write "\nexport default {\n"
    source_icons.each do |source_path|
        class_name = class_name(source_path)
        f.write "    #{class_name}: SvgIcon#{class_name},\n"
    end
    f.write "};\n"
end

