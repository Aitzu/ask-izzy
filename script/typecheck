#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'
export PATH=`npm bin`:$PATH
BOLD=$(tput bold)
END=$(tput sgr0)

function check {
    echo "${BOLD}$1${END}"
    bash -c "$1"
    echo "Good"
}

echo "${BOLD}Checking for missing @flow comments${END}"
echo "Good"

HAVE_FLOW=true
for file in $( git ls-files '**/*.js' ); do
    read flowtype < "$file"
    if test "x$flowtype" = 'x/* flow:disable */'; then
        echo "Skipping disabled file $file" > /dev/null
    elif test "x$flowtype" != 'x/* @flow */'; then
        HAVE_FLOW=false
        cat << EOF
$file is not annotated for flowtype (must be the first line)! - got "$flowtype"
EOF
    fi
done

if ! $HAVE_FLOW ; then
    exit 1
fi

check "jsonlint package.json > /dev/null"
check "eslint src/ test/"
check "sass-lint -v"
check "flow"
